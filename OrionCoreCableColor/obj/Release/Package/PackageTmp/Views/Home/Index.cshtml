<style>
    .card-container {
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .card-container-header {
        position: relative;
    }

    .overlay-header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1;
    }

    .card-content-header {
        position: relative;
        z-index: 2;
    }

    .hidden-button {
        display: none !important;
    }
</style>



<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-3">
            <div class="pt-5 pb-5 rounded overflow-hidden position-relative text-white card-container-header"
                 style="background-position: center; background-repeat: no-repeat; background-size: cover; background-image: url(/Content/img/fondocard.jpg); position: relative;">
                <div class="overlay-header" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);"></div>
                <i class="fal fa-user position-absolute opacity-50 mt-5" style="font-size: 8rem; bottom: 0; right: 0;"></i>
                <div class="row">
                    <!-- Parte izquierda: Texto Bienvenida y Hora Actual/Fecha -->
                    <div class="col-12 col-lg-5 mb-3 mb-lg-0 px-4 text-center text-lg-start">

                        <div class="card-content-header" style="position: relative; z-index: 10;">
                            <h3 class="text-white display-4 d-block l-h-n m-0 fw-500 text-capitalize" id="bienvenida"></h3>
                        </div>

                        <div class="card-content-header mt-3">
                            <h3 class="text-white display-5 d-block l-h-n m-0 fw-500" id="fecha"></h3>
                            <h3 class="text-white display-5 d-block l-h-n m-0 fw-500" id="hora"></h3>
                        </div>

                    </div>

                    <!-- Parte derecha: Tabs -->
                    <div class="col-12 col-lg-7 mb-3 mb-lg-0 px-4">
                        <div class="card-content-header text-center" style="position: relative; z-index: 10;">

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row" id="InventarioSinFirmar">
        <div class="col-sm-12">
            <label>Inventario sin confirmar:</label>
        </div>
    </div>
    <div class="row" id="BodegasAsignadas">

    </div>
    @if (User.IsInRole("Orion_Acceso_Dashboard"))
    {
        <div class="row">
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-success-700 rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="clienteactivoscant"></label>
                            <small class="m-0 l-h-n">Clientes Activos</small>
                        </h3>
                    </div>
                    <i class="fal fa-user position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n1" style="font-size:6rem"></i>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-danger-200 rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="clientecortados"></label>
                            <small class="m-0 l-h-n">Clientes Cortados</small>
                        </h3>
                    </div>
                    <i class="fal fa-user position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n1" style="font-size:6rem"></i>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-success-700 rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="clienteReconectados"></label>
                            <small class="m-0 l-h-n">Clientes Reconectados</small>
                        </h3>
                    </div>
                    <i class="fal fa-user position-absolute pos-right pos-bottom opacity-15 mb-n5 mr-n6" style="font-size: 8rem;"></i>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-warning-700 rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="clientesenatraso"></label>
                            <small class="m-0 l-h-n">Clientes Atrasados</small>
                        </h3>
                    </div>
                    <i class="fal fa-user position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n4" style="font-size: 6rem;"></i>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-success-700 rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="clientenuevo"></label>
                            <small class="m-0 l-h-n">Clientes Nuevos</small>
                        </h3>
                    </div>
                    <i class="fal fa-user position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n1" style="font-size:6rem"></i>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-secondary  rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="solicitudesporInstalar"></label>
                            <small class="m-0 l-h-n">Clientes por Instalar</small>
                        </h3>
                    </div>
                    <i class="fal fa-globe position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n4" style="font-size: 6rem;"></i>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-info-700 rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="ingresosmensuales"></label>
                            <small class="m-0 l-h-n">Ingresos Ventas</small>
                        </h3>
                    </div>
                    <i class="fal fa-dollar-sign position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n1" style="font-size:6rem"></i>
                </div>
            </div>


            <div class="col-sm-6 col-xl-3">
                <div class="p-3 bg-brand-gradient rounded overflow-hidden position-relative text-white mb-g">
                    <div class="">
                        <h3 class="text-white display-4 d-block l-h-n m-0 fw-500">
                            <label id="clientesprecalificados"></label>
                            <small class="m-0 l-h-n">Clientes Precalificados</small>
                        </h3>
                    </div>
                    <i class="fal fa-user position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n4" style="font-size: 6rem;"></i>
                </div>
            </div>
        </div>




        <div class="col-lg-12" style="display: block;">
            <div id="panel-1" class="panel panel-locked" data-panel-lock="false"
                 data-panel-close="false" data-panel-fullscreen="false" data-panel-collapsed="false"
                 data-panel-color="false" data-panel-locked="false" data-panel-refresh="false"
                 data-panel-reset="false">

                <div class="panel-hdr">
                    <!--aqui esta la parte del header -->
                    <h2>
                        Facturacion
                    </h2>
                    <div class="panel-toolbar pr-3 align-self-end">
                        <ul id="demo_panel-tabs" class="nav nav-tabs border-bottom-0 nav-tabs-clean"
                            role="tablist">
                        </ul>
                    </div>
                </div>

                <div class="panel-container show">
                    <div class="panel-content border-faded border-left-0 border-right-0 border-top-0">
                        <div class="row no-gutters">
                            <div class="col-lg-7 col-xl-8">
                                <div class="position-relative">
                                    <div class="custom-control custom-switch position-absolute pos-top pos-left ml-5 mt-3 z-index-cloud">
                                        <input type="checkbox" class="custom-control-input"
                                               id="start_interval">
                                    </div>
                                    <div id="updating-chart" style="height:242px"></div>
                                </div>
                            </div>
                            <div class="col-lg-5 col-xl-4 pl-lg-3" id="proyeccionmes">
                                @*<div class="d-flex mt-2">
                                        Arpu
                                        <span class="d-inline-block ml-auto">130 / 500</span>
                                    </div>
                                    <div class="progress progress-sm mb-3">
                                        <div class="progress-bar bg-fusion-400" role="progressbar"
                                             style="width: 65%;" aria-valuenow="65" aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex">
                                        Ventas
                                        <span class="d-inline-block ml-auto">440 TB</span>
                                    </div>
                                    <div class="progress progress-sm mb-3">
                                        <div class="progress-bar bg-success-500" role="progressbar"
                                             style="width: 34%;" aria-valuenow="34" aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex">
                                        Clientes Activos
                                        <span class="d-inline-block ml-auto">77%</span>
                                    </div>
                                    <div class="progress progress-sm mb-3">
                                        <div class="progress-bar bg-info-400" role="progressbar"
                                             style="width: 77%;" aria-valuenow="77" aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex">
                                        User Testing
                                        <span class="d-inline-block ml-auto">7 days</span>
                                    </div>
                                    <div class="progress progress-sm mb-g">
                                        <div class="progress-bar bg-primary-300" role="progressbar"
                                             style="width: 84%;" aria-valuenow="84" aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>*@
                                @*<div class="row no-gutters">
                                        <div class="col-6 pr-1">
                                            <a href="#" class="btn btn-default btn-block">Generate PDF</a>
                                        </div>
                                        <div class="col-6 pl-1">
                                            <a href="#" class="btn btn-default btn-block">Report a Bug</a>
                                        </div>
                                    </div>*@
                            </div>
                        </div>
                    </div>
                    <div class="panel-content p-0">

                        @*<div class="row row-grid no-gutters">
                                <div class="col-sm-12 col-md-6 col-lg-6 col-xl-3">
                                    <div class="px-3 py-2 d-flex align-items-center">
                                        <div class="js-easy-pie-chart color-primary-300 position-relative d-inline-flex align-items-center justify-content-center"
                                             data-percent="75" data-piesize="50" data-linewidth="5"
                                             data-linecap="butt" data-scalelength="0">
                                            <div class="d-flex flex-column align-items-center justify-content-center position-absolute pos-left pos-right pos-top pos-bottom fw-300 fs-lg">
                                                <span class="js-percent d-block text-dark"></span>
                                            </div>
                                        </div>
                                        <span class="d-inline-block ml-2 text-muted">
                                            SERVER LOAD
                                            <i class="fal fa-caret-up color-danger-500 ml-1"></i>
                                        </span>
                                        <div class="ml-auto d-inline-flex align-items-center">
                                            <div class="sparklines d-inline-flex" sparktype="line"
                                                 sparkheight="30" sparkwidth="70" sparklinecolor="#886ab5"
                                                 sparkfillcolor="false" sparklinewidth="1"
                                                 values="5,6,5,3,8,6,9,7,4,2"></div>
                                            <div class="d-inline-flex flex-column small ml-2">
                                                <span class="d-inline-block badge badge-success opacity-50 text-center p-1 width-6">97%</span>
                                                <span class="d-inline-block badge bg-fusion-300 opacity-50 text-center p-1 width-6 mt-1">44%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-6 col-xl-3">
                                    <div class="px-3 py-2 d-flex align-items-center">
                                        <div class="js-easy-pie-chart color-success-500 position-relative d-inline-flex align-items-center justify-content-center"
                                             data-percent="79" data-piesize="50" data-linewidth="5"
                                             data-linecap="butt">
                                            <div class="d-flex flex-column align-items-center justify-content-center position-absolute pos-left pos-right pos-top pos-bottom fw-300 fs-lg">
                                                <span class="js-percent d-block text-dark"></span>
                                            </div>
                                        </div>
                                        <span class="d-inline-block ml-2 text-muted">
                                            DISK SPACE
                                            <i class="fal fa-caret-down color-success-500 ml-1"></i>
                                        </span>
                                        <div class="ml-auto d-inline-flex align-items-center">
                                            <div class="sparklines d-inline-flex" sparktype="line"
                                                 sparkheight="30" sparkwidth="70" sparklinecolor="#1dc9b7"
                                                 sparkfillcolor="false" sparklinewidth="1"
                                                 values="5,9,7,3,5,2,5,3,9,6"></div>
                                            <div class="d-inline-flex flex-column small ml-2">
                                                <span class="d-inline-block badge badge-info opacity-50 text-center p-1 width-6">76%</span>
                                                <span class="d-inline-block badge bg-warning-300 opacity-50 text-center p-1 width-6 mt-1">3%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-6 col-xl-3">
                                    <div class="px-3 py-2 d-flex align-items-center">
                                        <div class="js-easy-pie-chart color-info-500 position-relative d-inline-flex align-items-center justify-content-center"
                                             data-percent="23" data-piesize="50" data-linewidth="5"
                                             data-linecap="butt">
                                            <div class="d-flex flex-column align-items-center justify-content-center position-absolute pos-left pos-right pos-top pos-bottom fw-300 fs-lg">
                                                <span class="js-percent d-block text-dark"></span>
                                            </div>
                                        </div>
                                        <span class="d-inline-block ml-2 text-muted">
                                            DATA TTF
                                            <i class="fal fa-caret-up color-success-500 ml-1"></i>
                                        </span>
                                        <div class="ml-auto d-inline-flex align-items-center">
                                            <div class="sparklines d-inline-flex" sparktype="line"
                                                 sparkheight="30" sparkwidth="70" sparklinecolor="#51adf6"
                                                 sparkfillcolor="false" sparklinewidth="1"
                                                 values="3,5,2,5,3,9,6,5,9,7"></div>
                                            <div class="d-inline-flex flex-column small ml-2">
                                                <span class="d-inline-block badge bg-fusion-500 opacity-50 text-center p-1 width-6">10GB</span>
                                                <span class="d-inline-block badge bg-fusion-300 opacity-50 text-center p-1 width-6 mt-1">10%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-6 col-xl-3">
                                    <div class="px-3 py-2 d-flex align-items-center">
                                        <div class="js-easy-pie-chart color-fusion-500 position-relative d-inline-flex align-items-center justify-content-center"
                                             data-percent="36" data-piesize="50" data-linewidth="5"
                                             data-linecap="butt">
                                            <div class="d-flex flex-column align-items-center justify-content-center position-absolute pos-left pos-right pos-top pos-bottom fw-300 fs-lg">
                                                <span class="js-percent d-block text-dark"></span>
                                            </div>
                                        </div>
                                        <span class="d-inline-block ml-2 text-muted">
                                            TEMP.
                                            <i class="fal fa-caret-down color-success-500 ml-1"></i>
                                        </span>
                                        <div class="ml-auto d-inline-flex align-items-center">
                                            <div class="sparklines d-inline-flex" sparktype="line"
                                                 sparkheight="30" sparkwidth="70" sparklinecolor="#fd3995"
                                                 sparkfillcolor="false" sparklinewidth="1"
                                                 values="5,3,9,6,5,9,7,3,5,2"></div>
                                            <div class="d-inline-flex flex-column small ml-2">
                                                <span class="d-inline-block badge badge-danger opacity-50 text-center p-1 width-6">124</span>
                                                <span class="d-inline-block badge bg-info-300 opacity-50 text-center p-1 width-6 mt-1">40F</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>*@

                    </div>
                </div>
            </div>
        </div>




        <div class="row d-flex" style="display: flex;">
            <div class="col-xl-6" style="display: flex;">
                <div id="panel-1" class="panel" style="flex: 1;">
                    <div class="panel-hdr">
                        <h2>
                            Comparativo <span class="fw-300"><i>Paquete-Servicio</i></span>
                        </h2>
                        <div class="panel-toolbar">
                            <button class="btn btn-panel" data-action="panel-collapse" data-toggle="tooltip" data-offset="0,10" data-original-title="Collapse"></button>
                            <button class="btn btn-panel" data-action="panel-fullscreen" data-toggle="tooltip" data-offset="0,10" data-original-title="Fullscreen"></button>
                            <button class="btn btn-panel" data-action="panel-close" data-toggle="tooltip" data-offset="0,10" data-original-title="Close"></button>
                        </div>
                    </div>
                    <div class="panel-container show">
                        <div class="panel-content">
                            <div class="panel-tag">
                                Gráfico comparativo entre solicitudes realizadas exclusivamente por internet y aquellas que incluyen artículos extra.
                            </div>
                            <div id="countextrachart" style="width: 100%; height: 1px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-6" style="display: flex;">
                <div id="panel-1" class="panel" style="flex: 1;">
                    <div class="panel-hdr">
                        <h2>
                            Mapa <span class="fw-300"><i>Direcciones de Clientes</i></span>
                        </h2>
                        <div class="panel-toolbar">
                            <button class="btn btn-panel" data-action="panel-collapse" data-toggle="tooltip" data-offset="0,10" data-original-title="Collapse"></button>
                            <button class="btn btn-panel" data-action="" data-toggle="tooltip" data-offset="0,10" data-original-title="Pantalla Completa" id="fullscreen-btn"><i class="fal fa-expand-arrows"></i></button>
                        </div>
                    </div>
                    <div class="panel-container show">
                        <div class="panel-content">
                            <div class="panel-tag">
                                Mapa con las direcciones de los clientes
                            </div>

                            <select id="clientes-select" class="form-control mb-3" style="padding:10px;"></select>

                            <div id="map" style="width: 100%; height: 545px; padding-top:10px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-xl-12">
                <div id="panel-1" class="panel">
                    <div class="panel-hdr">
                        <h2>
                            Fechas <span class="fw-300"><i>de Instalación</i></span>
                        </h2>
                        <div class="panel-toolbar">
                            <button class="btn btn-panel" data-action="panel-collapse" data-toggle="tooltip" data-offset="0,10" data-original-title="Collapse"></button>
                        </div>
                    </div>
                    <div class="panel-container show">
                        <div class="panel-content">
                            <div id="calendar"></div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="ModalInfoCalender" tabindex="-1" aria-labelledby="ModalInfoCalenderLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" style="text-transform:capitalize" id="nombreCliente"></h1>
                    </div>
                    <div class="modal-body">

                        <div id="fcDescripcion" style="text-align: center; margin: auto"> </div>

                        <div class="mb-3 mt-3">
                            <label for="fcNombreTecnico" class="form-label">Técnico Asignado:</label>
                            <input type="text" readonly style="text-transform:capitalize" class="form-control" id="fcNombreTecnico">
                        </div>

                        <div class="mb-3">
                            <label for="fcTelefonoCliente" class="form-label">Teléfono del Cliente:</label>
                            <input type="text" readonly style="text-transform:capitalize" class="form-control" id="fcTelefonoCliente">
                        </div>


                        <div class="mb-3">
                            <label for="fechaInstalacion" class="form-label">Fecha de Instalación:</label>
                            <input type="date" readonly class="form-control" id="fechaInstalacion">
                        </div>


                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="modalClose()">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>


    }
</div>



<script src="~/Content/js/datagrid/datatables/datatables.export.js"></script>
<script src="~/Content/js/statistics/ApexchartEchoaMano.js"></script>
<script src="~/Content/js/miscellaneous/fullcalendar/fullcalendar.bundle.js"></script>
<script src="~/Content/js/dependency/moment/moment.js"></script>
<script src="~/Content/js/statistics/sparkline/sparkline.bundle.js"></script>

@section Scripts{
    
    <script>
        debugger;



        var idInventarioSeleccionado = null;


        function FirmarInventario(fiIDInventarioMovimientoMaestro)
        {
            idInventarioSeleccionado = `#salidaInventario_${fiIDInventarioMovimientoMaestro}`;
            VerModalScrollConObjetoDeParametro({ fiIDInventarioMovimientoMaestro: fiIDInventarioMovimientoMaestro, usuarioPeticion: Usuario.usuarioPeticion }, "@Url.Action("FirmaInventarioSalida", "Home")");
        }

        $.ajax({
            url: "@Url.Action("GetInventarioPendientePorFirmar", "Home")",
            method: "Get",
            success: function (resp) {


                for (var item of resp) {

                    var $option = $(`<div class="col-sm-6 col-xl-3 inventario" id="salidaInventario_${item.fiIDInventarioMovimientoMaestro}">
                                        <div class="p-1 bg-warning-700 rounded overflow-hidden position-relative text-white mb-g">
                                            <div class="">
                                                <h3 class="text-white display-1 d-block l-h-n m-0 fw-500">
                                                    <small class="m-0 l-h-n">
                                                        <a style="text-decoration: underline;" class="text-white" href="javascript:FirmarInventario(${item.fiIDInventarioMovimientoMaestro});">
                                                            <i class="fal fal fa-exclamation-triangle"></i> Iventario de Fecha: ${moment(item.fdFechaCreacion).format("DD/MM/YYYY")}, articulos: ${item.fiCantidadArticulos}
                                                        </a>
                                                    </small>
                                                </h3>
                                            </div>
                                        </div>
                                    </div>`);

                    $("#InventarioSinFirmar").append($option);
                }

                if ($("#InventarioSinFirmar .inventario").children().length == 0)
                {
                    $("#InventarioSinFirmar").hide();
                }
            }
        });


        $.ajax({
            url: "@Url.Action("ListaProductosPorUsuario", "Home")",
            method: "Get",
            success: function (resp)
            {
                $("#BodegasAsignadas").html(resp);
                if ($("#BodegasAsignadas .inventarioUbicaciones").children().length == 0) {
                    $("#BodegasAsignadas").hide();
                }

            }
        });

        $(document).ready(function () {
            dataheader();
            setInterval(actualizarHora, 60000);
        });

        function dataheader() {
            var nombreUsuario = "@User.Identity.Name";
            var nuevoNombre = nombreUsuario.replace(/\./g, " ");
            $("#bienvenida").text("Bienvenido " + nuevoNombre);

            actualizarHora();
        }

        function actualizarHora() {
            var ahora = new Date();
            var opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            var fechaActual = ahora.toLocaleDateString('es-ES', opcionesFecha);

            var opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
            var horaActual = ahora.toLocaleTimeString('es-ES', opcionesHora);

            $("#fecha").text(fechaActual);
            $("#hora").text(horaActual);
        }
            /* line chart */

            function graf(data) {
                //console.log(data);

                //debugger
                var options = {
                    labels: ["Clientes con Productos", "Clientes con Servicios"],
                    series: [data.articulosExtra, data.articulosBase],
                    colors: ['#535085', '#FAA61C'],
                    plotOptions: {
                        pie: {
                            startAngle: 0,
                            endAngle: 360,
                            expandOnClick: true,
                            offsetX: 0,
                            offsetY: 0,
                            customScale: 1,
                            dataLabels: {
                                offset: 0,
                                minAngleToShowLabel: 10
                            },
                            donut: {
                                size: '65%',
                                background: 'transparent',
                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        showAlways: true,
                                        label: 'Total de Clientes',
                                        fontSize: '22px',
                                        fontFamily: 'Helvetica, Arial, sans-serif',
                                        fontWeight: 600,
                                        color: '#373d3f',
                                        formatter: function (w) {
                                            return w.globals.seriesTotals.reduce((a, b) => {
                                                return a + b
                                            }, 0)
                                        }
                                    }
                                }
                            },
                        }
                    },
                    chart: {
                        toolbar: {
                            show: true,
                            offsetX: 0,
                            offsetY: 0,
                            tools: {
                                download: true,
                                selection: true,
                                zoom: true,
                                zoomin: true,
                                zoomout: true,
                                pan: true,
                                reset: true | '<img src="/static/icons/reset.png" width="20">',
                                customIcons: []
                            },
                            export: {
                                csv: {
                                    filename: 'Grafica',
                                    columnDelimiter: ',',
                                    headerCategory: 'category',
                                    headerValue: 'value',
                                    dateFormatter(timestamp) {
                                        return new Date(timestamp).toDateString()
                                    }
                                },
                                svg: {
                                    filename: 'Grafica',
                                },
                                png: {
                                    filename: 'Grafica',
                                }
                            },
                            autoSelected: 'zoom'
                        },
                        type: 'donut',
                    },

                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {
                                width: 300
                            },
                            legend: {

                                position: 'bottom',
                                onItemClick: {
                                    toggleDataSeries: true
                                },
                            }
                        }
                    }]
                };

                var chart = new ApexCharts(document.querySelector("#countextrachart"), options);
                chart.render();

            }
            /* line chart -- end */


            bulletactualizacion()
            function bulletactualizacion() {
                $.ajax({
                    url: "@Url.Action("DashBoardInformativo", "Home")",
                    type: "POST",
                    //data: { IdSolicitud: idsol, IdCliente: idclien, Observaciones: " ", Opcion: 'Reiniciar Contrato' },
                    success: function (respuesta) {
                        //console.log(respuesta)
                        /*

                                fiClientesNetos,
		                        *fiClientesActivos,
		                        *fiClientesCortados,
		                        *fiClientesReconectados,
		                        *fiClientesEnAtraso,
		                        *fiClientesNuevosMes,
		                        *fiClientesPrecalificados,
		                        *fnIngresosdelMes,
		                        *fnIngresosdelGlobales

                         */
                        $(`#clienteactivoscant`).text(respuesta[0].fiClientesActivos)
                        $(`#clientecortados`).text(respuesta[0].fiClientesCortados)
                        $(`#clienteReconectados`).text(respuesta[0].fiClientesReconectados)
                        $(`#clientesenatraso`).text(respuesta[0].fiClientesEnAtraso)
                        $(`#clientenuevo`).text(respuesta[0].fiClientesNuevosMes)
                        $(`#ingresosmensuales`).text(`$${respuesta[0].fnIngresosdelMes}`)
                        $(`#solicitudesporInstalar`).text(respuesta[0].fiSolicitudesPorInstalar)
                        $(`#clientesprecalificados`).text(respuesta[0].fiClientesPrecalificadosDelMes)
                        //$(`#`).val(respuesta[0].)


                    },
                    error: function (respuesta) {
                        console.log(respuesta)
                    }
                });


                $.ajax({
                    url: "@Url.Action("PaqueteServicio", "Home")",
                    type: "GET",
                    success: function (respuesta) {
                        //console.log(respuesta)
                        var resultados = respuesta.reduce(function (acumulador, solicitud) {
                            if (solicitud.fcDescripcion == "Instalado" || solicitud.fcDescripcion == "Validado soporte") {
                                console.log(`entro aqui`);
                                if (solicitud.fbArticulosExtra) {
                                    acumulador.articulosExtra++;
                                } else {
                                    acumulador.articulosBase++;
                                }
                            }
                            return acumulador;
                        }, { articulosExtra: 0, articulosBase: 0 });

                        graf(resultados);
                    },
                    error: function (respuesta) {
                        console.log(respuesta);
                    }
                });




            }

        document.getElementById("fullscreen-btn").addEventListener("click", function () {
            var mapElement = document.getElementById("map");

            if (!document.fullscreenElement) {
                if (mapElement.requestFullscreen) {
                    mapElement.requestFullscreen();
                } else if (mapElement.mozRequestFullScreen) { // Firefox
                    mapElement.mozRequestFullScreen();
                } else if (mapElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    mapElement.webkitRequestFullscreen();
                } else if (mapElement.msRequestFullscreen) { // IE/Edge
                    mapElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        });

        function newPoint(coordenada, cliente) {
            var color;

            switch (cliente.fcDescripcion) {
                case "Pendiente":
                    color = "255,194,65";
                    break;
                case "Asignado":
                    color = "33,150,243";
                    break;
                case "Proceso":
                    color = "136,106,181";
                    break;
                case "Instalado":
                    color = "29,201,183";
                    break;
                case "Cancelado":
                    color = "253,57,149";
                    break;
                case "Validacion":
                    color = "134,142,150";
                    break;
                case "Validado soporte":
                    color = "80,80,80";
                    break;
                case "Revicion":
                    color = "134,142,150";
                    break;
                case "Finalizado":
                    color = "29,201,183";
                    break;
                default:
                    color = "0,0,0";
                    break;
            }

            return {
                'type': 'Feature',
                'properties': {
                    'fcNombreCliente': cliente.fcNombreCliente,
                    'fcIdentidad': cliente.fcIdentidad,
                    'fcTelefono': cliente.fcTelefono,
                    'fcIDPrestamo': cliente.fcIDPrestamo,
                    'fiIDSolicitud': cliente.fiIDSolicitud,
                    'fcDescripcion': cliente.fcDescripcion,
                    'fcNombreArchivo': cliente.fcNombreArchivo,
                    'fcRuta': cliente.fcRuta,
                    'color': color,
                    'fcGeolocalizacion': coordenada[0] + "," + coordenada[1],
                },
                'geometry': {
                    'type': 'Point',
                    'coordinates': [coordenada[1], coordenada[0]]
                }
            };
        }


        Mapa();

                 var urlimagenes = "@ViewBag.urlimagen";
    function Mapa() {
        var geojsonFeatures = [];
        var MAPTILER_KEY = 'CQjSsi4wjN5j99iwByjd';
        var uniqueDescriptions = new Set();
        var colorPalette = new Set();

        var allData = [];

        var map = new maplibregl.Map({
            style: `https://api.maptiler.com/maps/basic-v2/style.json?key=${MAPTILER_KEY}`,
            center: [-87.9828610499999, 15.508540420591633],
            zoom: 11.5,
            container: 'map',
            antialias: true
        });


        $.ajax({
            url: "@Url.Action("MapaCliente", "Home")",
            type: "GET",
            success: function (respuesta) {
                allData = respuesta;
                for (var i in respuesta) {
                    
                    if (/\d/.test(respuesta[i]["fcGeolocalizacion"])) {
                        var coordenadas = respuesta[i]["fcGeolocalizacion"].split(',').map(parseFloat);
                        geojsonFeatures.push(newPoint(coordenadas, respuesta[i]));
                        uniqueDescriptions.add(respuesta[i]["fcDescripcion"]);
                        colorPalette.add(respuesta[i]["fcRGB"]);
                    }
                }

                fillSelectWithDescriptions(uniqueDescriptions);

                map.on('styleimagemissing', (e) => {
                    const id = e.id; // id of the missing image

                    // check if this missing icon is one this function can generate
                    const prefix = 'square-rgb-';
                    if (id.indexOf(prefix) !== 0) return;

                    // extract the color from the id
                    const rgb = id.replace(prefix, '').split(',').map(Number);

                    const width = 64; // The image will be 64 pixels square
                    const bytesPerPixel = 4; // Each pixel is represented by 4 bytes: red, green, blue, and alpha.
                    const data = new Uint8Array(width * width * bytesPerPixel);

                    for (let x = 0; x < width; x++) {
                        for (let y = 0; y < width; y++) {
                            const offset = (y * width + x) * bytesPerPixel;
                            data[offset + 0] = rgb[0]; // red
                            data[offset + 1] = rgb[1]; // green
                            data[offset + 2] = rgb[2]; // blue
                            data[offset + 3] = 255; // alpha
                        }
                    }

                    map.addImage(id, { width, height: width, data });
                });

                map.on('load', () => {


                    map.addSource('points', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': geojsonFeatures
                        }
                    });

                    map.addLayer({
                        'id': 'points',
                        'type': 'symbol',
                        'source': 'points',
                        'layout': {
                            'icon-image': ['concat', 'square-rgb-', ['get', 'color']],
                            'icon-size': 0.2
                        }
                    });

                    map.on('click', 'points', (e) => {
                        debugger;
                        var coordinates = e.features[0].geometry.coordinates.slice();
                        var properties = e.features[0].properties;
                        var popupContent = `<div style="max-width: 500px; border-radius: 10px; background-color: white; padding: 10px;">
                                                <div style="display: flex;">
                                                    <div style="flex: 1; margin-right: 10px;">
                                                        <img class="img-thumbnail" src="${urlimagenes}?type=img&carpeta=${properties.fcRuta}&documento=${properties.fcNombreArchivo}" style="width: 100%; border-radius: 5px;" data-image="${properties.fcRuta}" data-description="Imagen del Cliente" />
                                                    </div>
                                                    <div style="flex: 2; display: flex; flex-direction: column; justify-content: space-between;">
                                                        <div>
                                                            <h3 style="margin: 0 0 10px; font-size: 1.25rem; color: rgb(${properties.color});">${properties.fcNombreCliente}</h3>
                                                            <div id="Descripcion" style=" border-radius: 5px; color: white; opacity: 0.8; text-align: center; padding: 5px 10px; background-color: rgb(${properties.color}); font-size: 1rem;">${properties.fcDescripcion ?? 'N/D'}</div>
                                                        <button id="btn-maps-${properties.fiIDSolicitud}" value="${properties.fcGeolocalizacion}" class="btn btn-sm bg-success text-white col-12" style="margin-top: 3px; display: inline-block;"><i class="fal fa-map-marker-alt"></i> Google Maps</button>
                                                        </div>
                                                        <div style="font-size: 0.875rem; line-height: 1.5;">
                                                            <p style="margin: 0;"><strong>Identidad:</strong> ${properties.fcIdentidad ?? 'N/D'}</p>
                                                            <p style="margin: 5px 0 0;"><strong>Teléfono:</strong> ${properties.fcTelefono ?? 'N/D'}</p>
                                                            <p style="margin: 5px 0 0;"><strong>ID Préstamo:</strong> ${properties.fcIDPrestamo ?? 'N/D'}</p>
                                                            <p style="margin: 5px 0 0;"><strong>ID Solicitud:</strong> ${properties.fiIDSolicitud ?? 'N/D'}</p>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`;


                        new maplibregl.Popup()
                            .setLngLat(coordinates)
                            .setHTML(popupContent)
                            .setMaxWidth("400px")

                            .addTo(map);

                        map.flyTo({
                            center: coordinates
                        });
                    });

                    map.on('mouseenter', 'points', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    map.on('mouseleave', 'points', () => {
                        map.getCanvas().style.cursor = '';
                    });
                });
            },
            error: function (respuesta) {
                console.log(respuesta);
            }
        });

    function IrAMaps(Localizacion) {
        console.log(Localizacion);
        let Latitud = Localizacion.split(',')[0];
        let Longitud = Localizacion.split(',')[1];
        let link = `https://www.google.com/maps?z=12&t=k&q=${Latitud},${Longitud}`;
        window.open(link, '_blank');
    }

    $(document).on('click', `[id^="btn-maps-"]`, function () {
        const geolocalizacion = $(this).attr('value');
        IrAMaps(geolocalizacion);
    });

    $('#clientes-select').on('change', function () {
        var selectedDescription = $(this).val();
        updateMapData(selectedDescription);
    });

    function updateMapData(description) {
        var filteredFeatures = [];
        if (description === 'vertodos') {
            filteredFeatures = geojsonFeatures;
        } else {
            for (var i in allData) {
                if (allData[i]["fcDescripcion"] === description && /\d/.test(allData[i]["fcGeolocalizacion"])) {
                    var coordenadas = allData[i]["fcGeolocalizacion"].split(',').map(parseFloat);
                    filteredFeatures.push(newPoint(coordenadas, allData[i]));
                }
            }
        }

        map.getSource('points').setData({
            'type': 'FeatureCollection',
            'features': filteredFeatures
        });
    }


    function fillSelectWithDescriptions(descriptions) {
        var select = $('#clientes-select');
        select.empty();
        select.append(`<option value="vertodos">Ver todos los Clientes</option>`);

        descriptions.forEach(function (description) {
            select.append(`<option value="${description}">${description}</option>`);
        });


        console.log('Select filled with unique descriptions'); // Debug
    }
}


    </script>


    <script>
        function newEvent(titulo, fecha, clase, objetocompleto) {
            var milliseconds = parseInt(fecha.replace(/\/Date\((-?\d+)\)\//, '$1'));
            var date = new Date(milliseconds);
            var momentDate = moment(date);
            var fechaformat = momentDate.format('YYYY-MM-DD');
            var todayDate = moment().startOf('day');


            var YM = todayDate.format('YYYY-MM');

            if (clase.trim() == "info") {
                var json = {
                    title: titulo,
                    description: objetocompleto,
                    start: fechaformat,
                    end: YM,
                    className: `bg-${clase} border-${clase} text-white`
                };
            }
            else {
                var json = {
                    title: titulo,
                    description: objetocompleto,
                    start: fechaformat,
                    className: `bg-${clase} border-${clase} text-white`
                };
            }


            return json;
        }



        function modalInfo(info) {
            var milliseconds = parseInt(info.fdFechaInstalacion.replace(/\/Date\((-?\d+)\)\//, '$1'));
            var date = new Date(milliseconds);
            var momentDate = moment(date);
            var fechaformat = momentDate.format('YYYY-MM-DD');


            $('#nombreCliente').text("Cliente: "+info.fcNombreCliente);
            $('#fechaInstalacion').val(fechaformat);
            $('#fcTelefonoCliente').val(info.fcTelefonoCliente);
            $('#fcNombreTecnico').val(info.fcNombreTecnico);
            $('#fcDescripcion').text(info.fcDescripcion);
            $('#fcDescripcion').removeClass();
            $('#fcDescripcion').addClass(`bg-${info.fcClase} text-white fs-2 opacity-50 col-12 pt-3 pb-3 rounded`);


            $('#ModalInfoCalender').modal('show');
        }


        function modalClose() {
            $('#ModalInfoCalender').modal('hide');
        }

        function inicializarCalendario() {
            var jsonEvent = [];

            $.ajax({
                url: "@Url.Action("ListaSolicitudes", "Contratista")",
                type: "GET",
                success: function (respuesta) {

                    for (var i in respuesta) {

                        if (["Pendiente", "Asignado", "Proceso", "Validacion", "Validado soporte"].includes(respuesta[i]["fcDescripcion"])) {

                            jsonEvent.push(newEvent(respuesta[i]["fcNombreCliente"], respuesta[i]["fdFechaInstalacion"], respuesta[i]["fcClase"], respuesta[i]));
                        }
                    }


                    var calendarEl = document.getElementById('calendar');

                    var calendar = new FullCalendar.Calendar(calendarEl, {

                        eventClick: function (info) {
                            modalInfo(info.event.extendedProps.description);
                        },

                        plugins: ['dayGrid', 'list', 'timeGrid', 'interaction', 'bootstrap'],
                        themeSystem: 'bootstrap',
                        timeZone: 'UTC',
                        buttonText: {
                            today: 'Hoy',
                            month: 'Mes',
                            week: 'Semana',
                            day: 'Día',
                            list: 'Listado'
                        },
                        eventTimeFormat: {
                            hour: 'numeric',
                            minute: '2-digit',
                            meridiem: 'short'
                        },
                        navLinks: true,
                        header: {
                            left: 'prev,next today addEventButton',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                        },
                        footer: {
                            left: '',
                            center: '',
                            right: ''
                        },
                        height: 700,
                        editable: false,
                        eventLimit: false,
                        views: {
                            sevenDays: {
                                type: 'agenda',
                                buttonText: '7 Días',
                                visibleRange: function (currentDate) {
                                    return {
                                        start: currentDate.clone().subtract(2, 'days'),
                                        end: currentDate.clone().add(5, 'days'),
                                    };
                                },
                                duration: {
                                    days: 7
                                },
                                dateIncrement: {
                                    days: 1
                                },
                            },
                        },

                        events: jsonEvent,
                        locale: 'es',
                        dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
                        monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                        monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']
                    });

                    calendar.render();
                },
                error: function (respuesta) {
                    console.log(respuesta);
                }
            });
        }


        inicializarCalendario();


        llenarReportes();
        function llenarReportes() {
            $.ajax({
                url: "@Url.Action("FacturacionMensual", "Home")",
                type: "GET",
                success: function (respuesta) {
                    console.log(respuesta);
                    const maxItem = respuesta.facturacionmensual.reduce((prev, current) => (prev.fnValorAbono > current.fnValorAbono) ? prev : current);

                    console.log(maxItem.fnValorAbono)

                    var res = []
                    var labelsxis = [];
                    for (const item of respuesta.facturacionmensual) {
                        res.push([item.fiMes, item.fnValorAbono])
                        labelsxis.push([item.fiMes, item.fcMes + `-$${item.fnValorAbono}`])
                    }
                    var opt = '';
                    for (const item of respuesta.proyecciones) {
                        opt += `<div class="d-flex mt-2">
                                    ${item.fcNombre}
                                    <span class="d-inline-block ml-auto">${item.fdActuales} / ${item.fdProyeccion}</span>
                                </div>
                                <div class="progress progress-sm mb-3">
                                    <div class="progress-bar ${item.fcClaseColor}" role="progressbar"
                                         style="width: ${item.fdPorcentaje}%;" aria-valuenow="${item.fdPorcentaje}" aria-valuemin="0"
                                         aria-valuemax="100"></div>
                                </div>`
                    }
                    $(`#proyeccionmes`).append(opt);

                    dasboarddetrading(res, maxItem.fnValorAbono + 1000, labelsxis);//el 1000 solo es para que en la grafica no llegue hasta el techo si no que tenga un margen
                    //console.log(getRandomData());
                },
                error: function (respuesta) {
                    console.log(respuesta);
                }
            });


        }
        var data = [],
            totalPoints = 200;
        var getRandomData = function ()
        {
            if (data.length > 0)
                data = data.slice(1);

            // do a random walk
            while (data.length < totalPoints) { //valores que deberia de ir la y
                var prev = data.length > 0 ? data[data.length - 1] : 50;
                var y = prev + Math.random() * 10 - 5;
                if (y < 0)
                    y = 0;
                if (y > 100)
                    y = 100;
                data.push(y);
            }

            // zip the generated y values with the x values
            var res = []; //valores que debe de ir la x como tal
            for (var i = 0; i < data.length; ++i)
                res.push([i, data[i]])
            console.log(res);
            return res;
        }


        function dasboarddetrading(datarespuesta, valormaximo,xislabels) {
            console.log(datarespuesta);
            console.log(valormaximo);

            var xLabels = [
                [0, 'Inicio'],
            ];

            for (const item of datarespuesta) {
                xLabels.push([, item])
            }
            var options = {
                //colors: [color.primary._700],
                colors: ['#535085'],
                series:
                {
                    lines:
                    {
                        show: true,
                        lineWidth: 0.5,
                        fill: 0.9,
                        fillColor:
                        {
                            colors: [
                                {
                                    opacity: 0.6
                                },
                                {
                                    opacity: 0
                                }]
                        },
                    },

                    shadowSize: 0 // Drawing is faster without shadows
                },
                grid:
                {
                    borderColor: 'rgba(0,0,0,0.05)',
                    borderWidth: 1,
                    labelMargin: 5
                },
                xaxis:
                {
                    ticks: xislabels,
                    color: '#F0F0F0',
                    tickColor: 'rgba(0,0,0,0.05)',
                    font:
                    {
                        size: 10,
                        color: '#999'
                    }
                },
                yaxis:
                {
                    min: 0,
                    //max: 100,
                    max: valormaximo,
                    color: '#F0F0F0',
                    tickColor: 'rgba(0,0,0,0.05)',
                    font:
                    {
                        size: 10,
                        color: '#999'
                    }
                }
            };
            //var plot = $.plot($("#updating-chart"), [getRandomData()], options);
            var plot = $.plot($("#updating-chart"), [datarespuesta], options);
        }


    </script>




}
