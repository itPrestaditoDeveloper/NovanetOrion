
<link href="~/Content/css/camaraweb.css" rel="stylesheet" />
<link href="~/Content/css/formplugins/cropperjs/cropper.css" rel="stylesheet" />

<div class="modal-header bg-primary-600 bg-primary-gradient">
    <h2 class="modal-title text-white">
        Escanear Producto <i class="fal fa-camera"></i>
    </h2>
    <button type="button" class="close" data-dismiss="modal">
        <i class="fal fa-times-circle fa-fw fa-lg"></i>
    </button>

</div>


<div class="modal-body">
    <div class="row">
        <div class="col-lg-12 text-center">
            <label style="display:none;" id="escaneoProducto">Producto</label>
        </div>
    </div>

    <div id="ProductoNoEncontrado">

        <main>
            <div id="reader"></div>
            <div id="result"></div>
        </main>
        @*<div class="col-lg-12 text-center">
            <div class="display-cover">

               <video autoplay></video>


                <canvas class="d-none"></canvas>

                <div class="video-options">
                    <select name="" id="" class="custom-select">
                        <option value="">Select camera</option>
                    </select>
                </div>

                <img class="screenshot-image d-none" alt="" style="display: none;">

                <div class="controls">
                    <button class="btn btn-danger play" title="Play"><i class="fal fa-play-circle"></i></button>
                    <button class="btn btn-info pause d-none" title="Pause"><i class="fal fa-pause"></i></button>
                    <button class="btn btn-outline-success screenshot d-none" title="ScreenShot"><i class="fal fa-image"></i></button>
                </div>
            </div>


        </div>
        <div class="col-xl-1"></div>
        <div class="col-xl-10">
            <div class="img-container">
                <img id="image" alt="Picture">
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" data-method="move" data-option="-10" data-second-option="0" id="MoveLeft" title="Move Left">
                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title="$().cropper(&quot;move&quot;, -10, 0)">
                        <span class="fal fa-arrow-left"></span>
                    </span>
                </button>
                <button type="button" class="btn btn-primary" data-method="move" data-option="10" data-second-option="0" title="Move Right" id="MoveRight">
                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title="$().cropper(&quot;move&quot;, 10, 0)">
                        <span class="fal fa-arrow-right"></span>
                    </span>
                </button>
                <button type="button" class="btn btn-primary" data-method="move" data-option="0" data-second-option="-10" title="Move Up" id="MoveUp">
                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title="$().cropper(&quot;move&quot;, 0, -10)">
                        <span class="fal fa-arrow-up"></span>
                    </span>
                </button>
                <button type="button" class="btn btn-primary" data-method="move" data-option="0" data-second-option="10" title="Move Down" id="MoveDown">
                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title="$().cropper(&quot;move&quot;, 0, 10)">
                        <span class="fal fa-arrow-down"></span>
                    </span>
                </button>
            </div>
            <button class="btn btn-success" id="obtenerCodigoBarraQr">Obtener Codigo</button>
        </div>*@
        <div class="row" id="BtnEnviar" style="padding-top: 10px;">
            <div class="col-sm-4">
                <select class="form-control" id="selectUsuarios">
                </select>
            </div>
            <div class="col-sm-2">
                <button type="button" class="btn btn-success" id="enviarFormulario">Enviar</button>
            </div>
        </div>
    </div>
    <div id="ProductoEncontrado" style="display:none;">
        <div class="row">

            <div class="col-lg-4">
                <div class="form-group">
                    <label class="control-label">Producto:</label>
                    <label class="control-label text-bold" style="font-weight:bolder;" id="fcProducto"></label>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="form-group">
                    <label class="control-label">Marca:</label>
                    <label class="control-label" style="font-weight: bolder;" id="fcMarca"></label>

                </div>
            </div>
            <div class="col-lg-4">
                <div class="form-group">
                    <label class="control-label">Modelo:</label>

                    <label class="control-label" style="font-weight: bolder;" id="fcModelo"></label>

                </div>
            </div>
            <div class="col-lg-4">
                <div class="form-group">
                    <label class="control-label">Tipo Producto:</label>

                    <label class="control-label" style="font-weight: bolder;" id="fcTipoProducto"></label>

                </div>
            </div>
            <div class="col-lg-4">
                <div class="form-group">
                    <label class="control-label">Valor L.:</label>

                    <label class="control-label" style="font-weight: bolder;" id="fnValorProductoMN"></label>

                </div>
            </div>
            <div class="col-lg-4">
                <div class="form-group">
                    <label class="control-label">Valor $:</label>

                    <label class="control-label" style="font-weight: bolder;" id="fnValorProductoME"></label>

                </div>
            </div>

            <div class="col-lg-4"></div>
            <div class="col-lg-4">
                Foto de Producto:
                <img onclick="ShowBigImage(this)" data-Description="" src="" alt="img" class="img-square img-md img-thumbnail" id="fcImagenProducto" style="cursor:pointer;width:100%;">
            </div>
            <div class="col-lg-4"></div>
            <div class="col-lg-4"></div>
            <div class="col-lg-4">
                <div class="form-group">
                    <div class="custom-control custom-checkbox">
                        <input disabled id="fiProductoInventariable" class="custom-control-input" style="margin-left:auto; margin-right:auto;" type="checkbox" name="CheckCheckedFalla"> <label>  </label>
                        <label class="custom-control-label" for="fiProductoInventariable">Producto Inventariable</label>
                    </div>
                </div>
            </div>
            <div class="col-lg-4"></div>
            <div class="col-lg-12">
                <hr />
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3">
                <div class="form-group">
                    <label class="control-label">Cantidad a ingresar</label>
                    <div class="input-group mar-btm" style="width:100%;">

                        <input type="number" id="cantidadIngresar" class="form-control" />
                    </div>

                </div>
            </div>

            <div class="col-sm-3">
                <div class="form-group">
                    <br />
                    <div class="input-group mar-btm" style="width:100%;">
                        <button type="button" class="btn btn-success" onclick="AgregarProductoLineas()">Agregar</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<script src="~/Content/js/formplugins/cropperjs/cropper.js"></script>
<script>


  


    var usuariosConectados = [];
    pantallaPrincipal = 1;
    $("#selectUsuarios").select2({ dropdownParent: $("#MyModalBig") });
    scanner = new Html5QrcodeScanner('reader', {
        // Scanner will be initialized in DOM inside element with id of 'reader'
        qrbox: {
            width: $("#MyModalBig").width() / 2,
            height: $("#MyModalBig").height() / 12,
        },  // Sets dimensions of scanning box (set relative to reader element width)
        fps: 20, // Frames per second to attempt a scan
    });

    scanner.render(success, error);


    function success(result) {
       
        $.ajax({
            url: "@Url.Action("GetInformacionBarCodeQr", "Productos")",
            type: 'Get',
            data: {codigo: result},

            success: function (resp) {
                if (resp.Estado) {
                    productoEscaneado = resp.producto;
                    $("#ProductoNoEncontrado").css("display", "none");
                    $("#ProductoEncontrado").css("display", "block");
                    $("#MensajeError").removeClass("text-danger");
                    $("#MensajeError").text("");
                    var producto = resp.producto;
                    $("#fcProducto").text(producto.fcProducto);
                    $("#fcMarca").text(producto.fcMarca);
                    $("#fcModelo").text(producto.fcModelo);
                    $("#fcTipoProducto").text(producto.fcTipoProducto);
                    $("#fnValorProductoMN").text(ConvertirDecimal(producto.fnValorProductoMN));
                    $("#fnValorProductoME").text(ConvertirDecimal(producto.fnValorProductoME));
                    $("#fiProductoInventariable").prop("checked", producto.fiProductoInventariable);
                    $("#fcImagenProducto").prop("src", producto.fcImagenProducto);

                    $("#MensajeError").addClass("text-danger");
                    $("#MensajeError").text(resp.Mensaje);
                    scanner.clear();
                    //var tablaT = $.fn.dataTable.Api("#TablaPrincipal");
                    //tablaT.ajax.reload();
            } else {
                $("#ProductoNoEncontrado").css("display", "block");
                $("#ProductoEncontrado").css("display", "none");
                $("#MensajeError").addClass("text-danger");
                $("#MensajeError").text(resp.Mensaje);
                //ToastrError("Productos", resp.Mensaje);
            }
                    ToastrError("Error", resp.Mensaje);
                    //$("#btnGuardarForm").show();




            }, error: function (resp) {
                ToastrError("Error", resp.Mensaje);
                //$("#btnGuardarForm").show();
            }
        });
    }




    function error(err) {
        //console.error(err);
        // Prints any errors to the console
    }

    $(document).on("hidden.bs.modal", "#MyModalBig", function () {
        pantallaPrincipal = 0;
        scanner.clear();
        $(document).empty();
    });



    chat.on('insertarUsuarios', function (resp, userPeticion) {
        if ("@User.Identity.Name" == userPeticion) {
            if (!usuariosConectados.some(x => x.UserName == resp.UserName)) {
                usuariosConectados.push(resp);
                let newOption = new Option(resp.UserName, resp.UserName, false, false);
                $("#selectUsuarios").append(newOption).trigger("change");
            }
        }

    });



    $.ajax({
        url: "@Url.Action("GetUsuariosConectados","Base")",
        method: "Get",
        success: function (resp) {

            //$("#BtnEnviar").append();
        }
    });

    $("#enviarFormulario").click(function () {
        var usuarioSeleccionado = usuariosConectados.find(x => x.UserName == $("#selectUsuarios").val());
        $.ajax({
            url: "@Url.Action("EnviarModalCamaraExterna", "Productos")",
            type: "Post",
            data: { usuario: usuarioSeleccionado ,titulo : "Escanear Serie de Producto", usuarioPeticion: "@User.Identity.Name" },
            success: function (resp) {

            }
        });

    });

    chat.on("retornarResultado", function (model) {
        if ("@User.Identity.Name" == model.UsuarioPeticion)
        {
            $.ajax({
                url: "@Url.Action("GetInformacionBarCodeQr", "Productos")",
                type: 'Get',
                data: { codigo: model.Codigo },

                success: function (resp) {
                   
                    if (resp.Estado) {
                        productoEscaneado = resp.producto;
                        $("#ProductoNoEncontrado").css("display", "none");
                        $("#ProductoEncontrado").css("display", "block");
                        $("#MensajeError").removeClass("text-danger");
                        $("#MensajeError").text("");
                        var producto = resp.producto;
                        $("#fcProducto").text(producto.fcProducto);
                        $("#fcMarca").text(producto.fcMarca);
                        $("#fcModelo").text(producto.fcModelo);
                        $("#fcTipoProducto").text(producto.fcTipoProducto);
                        $("#fnValorProductoMN").text(ConvertirDecimal(producto.fnValorProductoMN));
                        $("#fnValorProductoME").text(ConvertirDecimal(producto.fnValorProductoME));
                        $("#fiProductoInventariable").prop("checked", producto.fiProductoInventariable);
                        $("#fcImagenProducto").prop("src", producto.fcImagenProducto);

                        $("#MensajeError").addClass("text-danger");
                        $("#MensajeError").text(resp.Mensaje);
                        scanner.clear();
                        //var tablaT = $.fn.dataTable.Api("#TablaPrincipal");
                        //tablaT.ajax.reload();
                    } else {
                        $("#ProductoNoEncontrado").css("display", "block");
                        $("#ProductoEncontrado").css("display", "none");
                        $("#MensajeError").addClass("text-danger");
                        $("#MensajeError").text(resp.Mensaje);
                        //ToastrError("Productos", resp.Mensaje);
                    }
                    ToastrError("Error", resp.Mensaje);
                    //$("#btnGuardarForm").show();




                }, error: function (resp) {
                    ToastrError("Error", resp.Mensaje);
                    //$("#btnGuardarForm").show();
                }
            });
        }
    });



    function AgregarProductoLineas() {
        let tabla = $.fn.dataTable.Api("#TablaProductos");
        let lineas = parseInt($("#cantidadIngresar").val());
       
        for (var x = 0; x < lineas; x++) {
            let linea = NuevaLinea();
            linea.fnCantidad = 1;
            linea.fiIdProductoPreciosDetalleActual = productoEscaneado.fiIdProductoPreciosDetalleActual;
            linea.fiIDProducto = productoEscaneado.fiIDProducto;
            linea.fbEscaneado = true;
            tabla.row.add(linea).draw(false);
        }
        CerrarModal();
    }


    $(document).on("hidden.bs.modal", "#MyModalBig", function () {
        debugger;
        chat.off("retornarResultado");
    });


    //var $image = $('#image');
    //var $download = $('#download');
    //var $dataX = $('#dataX');
    //var $dataY = $('#dataY');
    //var $dataHeight = $('#dataHeight');
    //var $dataWidth = $('#dataWidth');
    //var $dataRotate = $('#dataRotate');
    //var $dataScaleX = $('#dataScaleX');
    //var $dataScaleY = $('#dataScaleY');

    //var options = {

    //    preview: '.img-preview',
    //    crop: function (e) {
    //        $dataX.val(Math.round(e.detail.x));
    //        $dataY.val(Math.round(e.detail.y));
    //        $dataHeight.val(Math.round(e.detail.height));
    //        $dataWidth.val(Math.round(e.detail.width));
    //        $dataRotate.val(e.detail.rotate);
    //        $dataScaleX.val(e.detail.scaleX);
    //        $dataScaleY.val(e.detail.scaleY);
    //    }
    //};

    //$image.on({
    //    ready: function (e) {
    //        console.log(e.type);
    //    },
    //    cropstart: function (e) {
    //        console.log(e.type, e.detail.action);
    //    },
    //    cropmove: function (e) {
    //        console.log(e.type, e.detail.action);
    //    },
    //    cropend: function (e) {
    //        console.log(e.type, e.detail.action);
    //    },
    //    crop: function (e) {
    //        console.log(e.type);
    //    },
    //    zoom: function (e) {
    //        console.log(e.type, e.detail.ratio);
    //    }
    //}).cropper(options);




    //controls = document.querySelector('.controls');
    //cameraOptions = document.querySelector('.video-options>select');
    //video = document.querySelector('video');
    //canvas = document.querySelector('canvas');
    //screenshotImage = document.querySelector('img');
    //buttons = $(controls).find("button").toArray(); //[...controls.querySelectorAll('button')];
    //streamStarted = false;

    //var [play, pause, screenshot] = buttons;

    //letraints = {
    //    video: {
    //        width: {
    //            min: 1280,
    //            ideal: 1920,
    //            max: 2560,
    //        },
    //        height: {
    //            min: 720,
    //            ideal: 1080,
    //            max: 1440
    //        },
    //        deviceId: 0
    //    }
    //};

    //cameraOptions.onchange = () => {

    //    //let updatedletraints = {
    //    //    ...letraints,
    //    //    deviceId: {
    //    //        exact: cameraOptions.value
    //    //    }
    //    //};
    //    let updatedletraints = letraints;
    //    updatedletraints.video.deviceId = cameraOptions.value;
    //    letraints.deviceId = cameraOptions.value;
    //    startStream(updatedletraints);
    //};

    //play.onclick = () => {
    //    if (streamStarted) {
    //        video.play();
    //        play.classList.add('d-none');
    //        pause.classList.remove('d-none');
    //        return;
    //    }
    //    if ('mediaDevices' in navigator && navigator.mediaDevices.getUserMedia) {

    //        //let updatedletraints = {
    //        //    ...letraints,
    //        //    deviceId: {
    //        //        exact: cameraOptions.value
    //        //    }
    //        //};

    //        let updatedletraints = letraints;
    //        updatedletraints.video.deviceId = cameraOptions.value;
    //        letraints.deviceId = cameraOptions.value;
    //        startStream(updatedletraints);
    //    }
    //};

    //var pauseStream = () => {
    //    video.pause();
    //    play.classList.remove('d-none');
    //    pause.classList.add('d-none');
    //};

    //var doScreenshot = () => {
    //    canvas.width = video.videoWidth;
    //    canvas.height = video.videoHeight;
    //    canvas.getContext('2d').drawImage(video, 0, 0);
    //    //screenshotImage.src = canvas.toDataURL('image/webp');
    //    let base64 = canvas.toDataURL('image/png');
    //    screenshotImage.src = base64;
    //    screenshotImage.classList.remove('d-none');
    //    $image.cropper("destroy");
    //    $image.prop("src", base64);

    //    $image.cropper(options);



    //};

    //pause.onclick = pauseStream;
    //screenshot.onclick = doScreenshot;

    //var startStream = async (letraints) => {
    //    let stream = await navigator.mediaDevices.getUserMedia(letraints);
    //    handleStream(stream);
    //}

    //var stopStream = async () => {

    //    let stream = await navigator.mediaDevices.getUserMedia(letraints);
    //    handleStreamStop(stream);

    //}


    //var handleStream = (stream) => {

    //    let video2 = $(`<video autoplay></video>`);
    //    let objeto = $(".display-cover");

    //    $(objeto).find("video").remove("video");
    //    $(objeto).prepend(video2);
    //    video = document.querySelector('video');

    //    video.srcObject = stream;
    //    play.classList.add('d-none');
    //    pause.classList.remove('d-none');
    //    screenshot.classList.remove('d-none');

    //};

    //var handleStreamStop = (stream) => {
    //    let tracks = stream.getVideoTracks();
    //    video = document.querySelector('video');

    //    tracks.forEach((track) => {
    //        track.stop();
    //    });

    //    video.srcObject.getVideoTracks().forEach(track => {
    //        track.stop()
    //        video.srcObject.removeTrack(track);
    //        $("#MyModalContentBig").empty();
    //    });

    //    stream = null;
    //    //stream.load();





    //}


    //var getCameraSelection = async () => {
    //    let devices = await navigator.mediaDevices.enumerateDevices();
    //    let videoDevices = devices.filter(device => device.kind === 'videoinput');
    //    let options = videoDevices.map(videoDevice => {
    //        return `<option value="${videoDevice.deviceId}">${videoDevice.label}</option>`;
    //    });
    //    cameraOptions.innerHTML = options.join('');
    //};

    //getCameraSelection();

    //$(document).on("hidden.bs.modal", "#MyModalBig", function () {



    //    stopStream();

    //});


    //function dataURLtoFile(dataurl, filename) {
    //    var arr = dataurl.split(','),
    //        mime = arr[0].match(/:(.*?);/)[1],
    //        bstr = atob(arr[arr.length - 1]),
    //        n = bstr.length,
    //        u8arr = new Uint8Array(n);
    //    while (n--) {
    //        u8arr[n] = bstr.charCodeAt(n);
    //    }
    //    return new File([u8arr], filename, { type: mime });
    //}



    //$("#MoveLeft").click(function () {
    //    $image.cropper("move", -10, 0);
    //});

    //$("#MoveRight").click(function () {
    //    $image.cropper("move", 10, 0);
    //});

    //$("#MoveUp").click(function () {
    //    $image.cropper("move", 0, -10);
    //});


    //$("#MoveDown").click(function () {
    //    $image.cropper("move", 0, 10);
    //});


    @* $("#obtenerCodigoBarraQr").click(function () {
        var recorte = $image.cropper("getCroppedCanvas", { width: 160, height: 90 });
        let recortebase64 = recorte.toDataURL('image/png');
        debugger;
        var file = dataURLtoFile(recortebase64, "barCode.png");
        var form_data = new FormData();
        form_data.append("file", file);
        $.ajax({
            url: "@Url.Action("GetInformacionBarCodeQr", "Productos")",
            type: 'POST',
            data: form_data,
            cache: false,
            contentType: false,
            processData: false,
            enctype: "multipart/form-data",
            success: function (resp) {
                if (resp.Estado) {
                    productoEscaneado = resp.producto;
                    $("#ProductoNoEncontrado").css("display", "none");
                    $("#ProductoEncontrado").css("display", "block");
                    $("#MensajeError").removeClass("text-danger");
                    $("#MensajeError").text("");
                    var producto = resp.producto;
                    $("#fcProducto").text(producto.fcProducto);
                    $("#fcMarca").text(producto.fcMarca);
                    $("#fcModelo").text(producto.fcModelo);
                    $("#fcTipoProducto").text(producto.fcTipoProducto);
                    $("#fnValorProductoMN").text(ConvertirDecimal(producto.fnValorProductoMN));
                    $("#fnValorProductoME").text(ConvertirDecimal(producto.fnValorProductoME));
                    $("#fiProductoInventariable").prop("checked", producto.fiProductoInventariable);
                    $("#fcImagenProducto").prop("src", producto.fcImagenProducto);

                    $("#MensajeError").addClass("text-danger");
                    $("#MensajeError").text(resp.Mensaje);

                    //var tablaT = $.fn.dataTable.Api("#TablaPrincipal");
                    //tablaT.ajax.reload();
                } else {
                    $("#ProductoNoEncontrado").css("display", "block");
                    $("#ProductoEncontrado").css("display", "none");
                    $("#MensajeError").addClass("text-danger");
                    $("#MensajeError").text(resp.Mensaje);
                    //ToastrError("Productos", resp.Mensaje);
                }
                ToastrError("Error", resp.Mensaje);
                //$("#btnGuardarForm").show();




            }, error: function (resp) {
                ToastrError("Error", resp.Mensaje);
                //$("#btnGuardarForm").show();
            }
        });
    });*@









</script>